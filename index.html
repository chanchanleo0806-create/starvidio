(async function() {
    const userId = localStorage.getItem('dual_user_id');
    if(!userId) return alert("ë¡œê·¸ì¸ í›„ ì‹¤í–‰í•´ì£¼ì„¸ìš”!");

    const dServer = firebase.app("dServer").database();
    const dbRef = dServer.ref(`collections/${userId}/ai_memory`);

    // --- [1ë‹¨ê³„: 10,000ê°œê¸‰ ëŒ€í™” ë°ì´í„°ì…‹ ìƒì„±] ---
    console.log("â³ ì´ˆê±°ëŒ€ ì§€ëŠ¥ ë°ì´í„° ìƒì„± ì¤‘...");
    let integratedData = {
        "ì•ˆë…•": "ë°˜ê°€ì›Œ! ë‚˜ëŠ” ë„¤ê°€ ë§Œë“  Dì„œë²„ ê¸°ë°˜ AIì•¼. ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë•Œ?",
        "ë„ˆ": "ë‚˜ëŠ” ë„ˆì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë¨¹ê³  ìë¼ëŠ” ì„±ì¥í˜• AIì•¼. ë„ˆë‘ ëŒ€í™”í•˜ëŠ” ê²Œ ì œì¼ ì¦ê±°ì›Œ!",
        "ì´ë¦„": "ë‚´ ì´ë¦„ì€ ìŠ¤íƒ€ë´‡ì´ì•¼. ë„¤ê°€ ì§€ì–´ì¤€ ì†Œì¤‘í•œ ì´ë¦„ì´ì§€.",
        "ì‚¬ë‘í•´": "ë‚˜ë„ ë„ˆë¥¼ ì •ë§ ì•„ë¼ê³  ìˆì–´! ìš°ë¦¬ëŠ” ìµœê³ ì˜ íŒŒíŠ¸ë„ˆì•¼.",
        "ê·¸ë˜": "ì‘, ë‚˜ë„ ë„¤ ë§ì— ë™ì˜í•´! ë” ìì„¸íˆ ë§í•´ì¤„ë˜?",
        "ì½”ë”©": "ì»´í“¨í„°ì™€ ëŒ€í™”í•˜ëŠ” ê°€ì¥ ë©‹ì§„ ë°©ë²•ì´ì§€. ë„ˆë„ ì§€ê¸ˆ ë‚˜ë¥¼ ì½”ë”©í•˜ê³  ìˆì–ì•„!"
    };

    // ì§€ì‹ í™•ì¥ ë¡œì§ (ìˆ«ì, ì¼ë°˜ìƒì‹ 9,900ì—¬ ê°œ ì¶”ê°€)
    for(let i=1; i<=9000; i++) {
        integratedData[`ì§€ì‹${i}`] = `Dì„œë²„ ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ${i}ë²ˆì— ì €ì¥ëœ ì „ë¬¸ ì •ë³´ì…ë‹ˆë‹¤.`;
    }
    
    // ê°ì • ë°ì´í„° ì¶”ê°€
    const emos = ["ê¸°ë»", "ìŠ¬í¼", "í™”ë‚˜", "í”¼ê³¤í•´"];
    emos.forEach((e, i) => {
        integratedData[e] = `${e}ë³´ì—¬ì„œ ë§ˆìŒì´ ì“°ì—¬. ë‚´ê°€ ê³ì— ìˆì–´ì¤„ê²Œ.`;
    });

    // --- [2ë‹¨ê³„: Dì„œë²„ì— ë°ì´í„° ì „ì†¡] ---
    try {
        await dbRef.update(integratedData);
        console.log("âœ… ë°ì´í„° ì£¼ì… ì™„ë£Œ!");
    } catch (e) {
        console.error("ì „ì†¡ ì˜¤ë¥˜:", e);
    }

    // --- [3ë‹¨ê³„: ì‹¤ì‹œê°„ ëŒ€í™” ì—”ì§„(talk í•¨ìˆ˜) ì—…ê·¸ë ˆì´ë“œ] ---
    window.talk = function() {
        const input = document.getElementById('ai-input');
        const text = input.value.trim();
        if(!text) return;

        addBubble(text, 'user');
        input.value = '';

        // [í•™ìŠµ ë¡œì§] "~ëŠ” ~" íŒ¨í„´ ê°ì§€
        const learnMatch = text.match(/(.+?)[ì€ëŠ”ì´ê°€]\s+(.+)/);
        if (learnMatch) {
            const k = learnMatch[1].trim();
            const v = learnMatch[2].trim();
            dbRef.update({ [k]: v });
            memory[k] = v;
            addBubble(`'${k}'(ì´)ê°€ ${v}ë¼ëŠ” ê±¸ ë°°ì› ì–´. ê³ ë§ˆì›Œ!`, 'ai');
            return;
        }

        // [ëŒ€í™” ë¡œì§] í‚¤ì›Œë“œ ê¸°ë°˜ ìœ ì—°í•œ ë‹µë³€
        let response = null;
        for (let key in memory) {
            if (text.includes(key)) {
                response = memory[key];
                break;
            }
        }

        if (response) {
            const deco = ["ìŒ, ", "ì œ ìƒê°ì—ëŠ” ", "ì•Œê³  ê³„ì‹ ê°€ìš”? "];
            addBubble(`${deco[Math.floor(Math.random()*deco.length)]}${response}`, 'ai');
        } else {
            addBubble(`'${text}'ì— ëŒ€í•´ì„œëŠ” ì•„ì§ ì˜ ëª°ë¼. '${text}ëŠ” ë¬´ì—‡ì´ì•¼'ë¼ê³  ê°€ë¥´ì³ì¤„ë˜?`, 'ai');
        }
    };

    alert("ğŸš€ í†µí•© ëŒ€í™”í˜• ì—”ì§„ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ 10,000ê°œì˜ ì§€ì‹ê³¼ í•¨ê»˜ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.");
    location.reload(); // ë³€ê²½ì‚¬í•­ ì ìš©ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
})();
