<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STAR TOTAL PLATFORM</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --main-red: #e94560; --bg-dark: #050505; --yellow: #fee500; --card-bg: #16213e; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg-dark); color: white; margin: 0; overflow: hidden; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ */
        nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #1a1a2e; display: flex; justify-content: space-around; align-items: center; border-top: 2px solid var(--main-red); z-index: 1000; }
        nav div { cursor: pointer; font-size: 22px; color: #888; }
        nav div.active { color: var(--main-red); }

        .section { display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 20px; }
        .section.active { display: block; }

        /* ë¹„ë””ì˜¤ UI */
        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .v-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .v-card video { width: 100%; height: 110px; object-fit: cover; }

        /* ì±„íŒ… UI */
        #chat-window { position: fixed; inset: 0; background: #abc1d1; display: none; flex-direction: column; z-index: 2000; color: #000; }
        #chat-view { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 8px 12px; border-radius: 12px; font-size: 14px; max-width: 80%; }
        .me { align-self: flex-end; background: var(--yellow); }
        .you { align-self: flex-start; background: #fff; }

        /* ë¡œê·¸ì¸ ëª¨ë‹¬ */
        .modal { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .modal-content { background: #1a1a2e; padding: 40px 30px; border-radius: 30px; text-align: center; border: 1px solid var(--main-red); width: 300px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; font-size: 16px; }
    </style>
</head>
<body>

<div id="auth-ui" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--main-red)">STAR PLATFORM</h2>
        <input type="text" id="log-id" placeholder="ì•„ì´ë””">
        <input type="password" id="log-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="handleLogin()" style="width:100%; padding:15px; background:var(--main-red); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">ë¡œê·¸ì¸</button>
        <button onclick="handleSignup()" style="width:100%; padding:10px; background:none; color:#aaa; border:none; cursor:pointer; margin-top:10px;">íšŒì›ê°€ì…</button>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div id="sec-video" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--main-red)">Star Video</h2>
            <button onclick="document.getElementById('file-input').click()" style="background:#4caf50; border:none; color:white; padding:8px 15px; border-radius:8px;">ì—…ë¡œë“œ</button>
        </div>
        <div class="v-grid" id="video-list"></div>
    </div>

    <div id="sec-talk" class="section">
        <h2>Messages</h2>
        <div id="friend-list"></div>
        <button onclick="addFriend()" style="width:100%; padding:15px; margin-top:15px; border-radius:12px; border:1px dashed #555; background:none; color:#888;">+ ì¹œêµ¬ ì•„ì´ë”” ì¶”ê°€</button>
    </div>

    <nav>
        <div onclick="showSec('video')">ğŸ“º</div>
        <div onclick="showSec('talk')">ğŸ’¬</div>
        <div onclick="doLogout()">ğŸšª</div>
    </nav>
</div>

<div id="chat-window">
    <div style="padding:15px; background:rgba(0,0,0,0.1); display:flex; align-items:center;">
        <button onclick="closeChat()" style="border:none; background:none; font-size:20px;">â—€</button>
        <b id="chat-target" style="margin-left:15px;"></b>
    </div>
    <div id="chat-view"></div>
    <div style="padding:10px; background:#fff; display:flex; gap:10px;">
        <input type="text" id="msg-input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; color:#000;" placeholder="ë©”ì‹œì§€..." onkeypress="if(event.keyCode==13) sendMsg()">
        <button onclick="sendMsg()" style="background:var(--yellow); border:none; padding:10px 15px; border-radius:15px; font-weight:bold;">ì „ì†¡</button>
    </div>
</div>

<input type="file" id="file-input" style="display:none" accept="video/*">

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA-Qkz57KR0i55lTbrsu0rZk282-ma_4MA",
        authDomain: "star-vidio.firebaseapp.com",
        projectId: "star-vidio",
        storageBucket: "star-vidio.firebasestorage.app",
        messagingSenderId: "1035567764991",
        appId: "1:1035567764991:web:4fd92a5591da039da503ca",
        databaseURL: "https://star-vidio-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rdb = firebase.database();
    const storage = firebase.storage();

    let currentUser = null;
    let activeRid = null;

    // [í•µì‹¬] í†µí•© íšŒì›ê°€ì… (ì–‘ìª½ DB ì—°ë™)
    window.handleSignup = async () => {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();
        if(!id || !pw) return alert("ì…ë ¥í•˜ì„¸ìš”!");

        const check = await db.collection("users").doc(id).get();
        if(check.exists) return alert("ì´ë¯¸ ìˆëŠ” ì•„ì´ë””!");

        await Promise.all([
            db.collection("users").doc(id).set({id, pw, nick: id, createdAt: new Date()}),
            rdb.ref(`users/${id}`).set({id, pw})
        ]);
        alert("í†µí•© ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•˜ì„¸ìš”.");
    };

    // [í•µì‹¬] í†µí•© ë¡œê·¸ì¸ (ì„¸ì…˜ ìœ ì§€ ì¶”ê°€)
    window.handleLogin = async () => {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();

        const doc = await db.collection("users").doc(id).get();
        if(doc.exists && doc.data().pw === pw) {
            currentUser = doc.data();
            localStorage.setItem('star_user_id', id);
            loginSuccess();
        } else alert("ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");
    };

    function loginSuccess() {
        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        loadVideos();
        loadFriends();
    }

    // ë¹„ë””ì˜¤ ë¡œë“œ
    function loadVideos() {
        db.collection("videos").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('video-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const v = doc.data();
                const div = document.createElement('div');
                div.className = 'v-card';
                div.innerHTML = `<video src="${v.url}" muted></video><div style="padding:8px;font-size:12px;">${v.title}</div>`;
                list.appendChild(div);
            });
        });
    }

    // íŒŒì¼ ì—…ë¡œë“œ
    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const ref = storage.ref('videos/' + Date.now() + "_" + file.name);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        await db.collection("videos").add({
            title: file.name, url, uploader: currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ì—…ë¡œë“œ ì™„ë£Œ!");
    };

    // ì±„íŒ… ê¸°ëŠ¥
    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
    }

    function addFriend() {
        const fid = prompt("ì¹œêµ¬ ì•„ì´ë””:");
        if(fid) rdb.ref(`friends/${currentUser.id}/${fid}`).set(true);
    }

    function loadFriends() {
        rdb.ref(`friends/${currentUser.id}`).on('value', snap => {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            if(snap.exists()) {
                Object.keys(snap.val()).forEach(fid => {
                    const d = document.createElement('div');
                    d.style = "padding:15px; background:#16213e; border-radius:10px; margin-bottom:10px; cursor:pointer;";
                    d.innerText = "ğŸ‘¤ " + fid;
                    d.onclick = () => openChat(fid);
                    list.appendChild(d);
                });
            }
        });
    }

    function openChat(fid) {
        activeRid = [currentUser.id, fid].sort().join('_');
        document.getElementById('chat-target').innerText = fid;
        document.getElementById('chat-window').style.display = 'flex';
        rdb.ref(`msgs/${activeRid}`).on('value', snap => {
            const v = document.getElementById('chat-view'); v.innerHTML = '';
            if(snap.exists()) {
                Object.values(snap.val()).forEach(m => {
                    const d = document.createElement('div');
                    d.className = `bubble ${m.s === currentUser.id ? 'me' : 'you'}`;
                    d.innerText = m.t;
                    v.appendChild(d);
                });
            }
            v.scrollTop = v.scrollHeight;
        });
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value.trim()) return;
        rdb.ref(`msgs/${activeRid}`).push({ s: currentUser.id, t: i.value.trim() });
        i.value = '';
    }

    function closeChat() { document.getElementById('chat-window').style.display = 'none'; }
    function doLogout() { localStorage.clear(); location.reload(); }

    // ìë™ ë¡œê·¸ì¸
    window.onload = async () => {
        const savedId = localStorage.getItem('star_user_id');
        if (savedId) {
            const doc = await db.collection("users").doc(savedId).get();
            if (doc.exists) { currentUser = doc.data(); loginSuccess(); }
        }
    };
</script>
</body>
</html>
