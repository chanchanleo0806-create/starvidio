<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Video - Gun Game Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --main-red: #ff4757; --bg: #0a0a0c; --card: #1a1a2e; --yellow: #fee500; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        
        header { background: #111; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--main-red); }
        .logo { color: var(--main-red); font-weight: bold; font-size: 20px; text-shadow: 0 0 10px rgba(255, 71, 87, 0.5); }

        nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #111; display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 1px solid #222; }
        nav div { cursor: pointer; font-size: 24px; transition: 0.2s; color: #555; }
        nav div.active { color: var(--main-red); }

        .section { display: none; height: calc(100vh - 125px); overflow-y: auto; padding: 15px; }
        .section.active { display: block; }

        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .v-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #333; position: relative; }
        .v-card video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; }
        
        #auth-ui { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: #1a1a2e; padding: 35px 25px; border-radius: 25px; width: 300px; text-align: center; border: 1px solid var(--main-red); box-shadow: 0 0 20px rgba(255, 71, 87, 0.2); }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #0a0a0c; color: white; font-size: 15px; outline: none; }
        .btn { background: var(--main-red); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        #chat-window { position: fixed; inset: 0; background: #abc1d1; display: none; flex-direction: column; z-index: 2000; color: #000; }
        #chat-view { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 10px 14px; border-radius: 15px; font-size: 14px; max-width: 80%; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble.me { align-self: flex-end; background: var(--yellow); }
    </style>
</head>
<body>

<div id="auth-ui">
    <div class="auth-box">
        <h2 style="color:var(--main-red); margin-top:0;">â˜… STAR VIDEO</h2>
        <p style="font-size:12px; color:#888;">GUN GAME PROJECT ì—°ë™ë¨</p>
        <input type="text" id="log-id" placeholder="ì•„ì´ë””">
        <input type="password" id="log-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
        <p onclick="handleSignup()" style="font-size:13px; margin-top:20px; cursor:pointer; color:#aaa;">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span style="color:var(--main-red)">íšŒì›ê°€ì…</span></p>
    </div>
</div>

<header id="main-header" style="display:none;">
    <div class="logo">Star Video</div>
    <button onclick="document.getElementById('file-input').click()" style="background:#4caf50; color:white; border:none; padding:6px 15px; border-radius:20px; font-size:12px; font-weight:bold;">+ ì—…ë¡œë“œ</button>
</header>

<div id="main-app" style="display:none;">
    <div id="sec-video" class="section active">
        <div class="v-grid" id="video-list"></div>
    </div>
    
    <div id="sec-talk" class="section">
        <h3 style="margin-top:0;">ëŒ€í™” ëª©ë¡</h3>
        <div id="friend-list"></div>
        <button onclick="addFriend()" style="width:100%; padding:15px; margin-top:15px; background:rgba(255,255,255,0.05); border:1px dashed #444; color:#888; border-radius:10px;">+ ì¹œêµ¬ ì¶”ê°€ (ì•„ì´ë””)</button>
    </div>
</div>

<nav id="main-nav" style="display:none;">
    <div onclick="showSec('video')" id="nav-video" class="active">ğŸ“º</div>
    <div onclick="showSec('talk')" id="nav-talk">ğŸ’¬</div>
    <div onclick="doLogout()">ğŸšª</div>
</nav>

<div id="chat-window">
    <div style="padding:15px; background:rgba(0,0,0,0.05); display:flex; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1);">
        <button onclick="closeChat()" style="border:none; background:none; font-size:24px; cursor:pointer;">&lsaquo;</button>
        <b id="chat-target" style="margin-left:15px; font-size:16px;"></b>
    </div>
    <div id="chat-view"></div>
    <div style="padding:12px; background:#fff; display:flex; gap:10px; align-items:center;">
        <input type="text" id="msg-input" style="flex:1; padding:10px 15px; border-radius:20px; border:1px solid #ddd; color:#000;" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMsg()">
        <button onclick="sendMsg()" style="background:var(--yellow); border:none; padding:10px 18px; border-radius:18px; font-weight:bold; cursor:pointer;">ì „ì†¡</button>
    </div>
</div>

<input type="file" id="file-input" style="display:none" accept="video/*">

<script>
    // --- gun-game-90491 ì„¤ì • ì ìš© ---
    const firebaseConfig = {
        apiKey: "AIzaSyD_8QEOfKW32mQ1WBRLmp8zdSTf_e2ZAsI",
        authDomain: "gun-game-90491.firebaseapp.com",
        databaseURL: "https://gun-game-90491-default-rtdb.firebaseio.com",
        projectId: "gun-game-90491",
        storageBucket: "gun-game-90491.firebasestorage.app",
        messagingSenderId: "1014020821808",
        appId: "1:1014020821808:web:015da7ec9066d9aa20eef5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rdb = firebase.database();
    const storage = firebase.storage();

    let currentUser = null;
    let activeRid = null;

    // í†µí•© íšŒì›ê°€ì… (Firestore + Realtime DB ë™ì‹œ ì—°ë™)
    window.handleSignup = async () => {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();
        if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

        try {
            const check = await db.collection("users").doc(id).get();
            if(check.exists) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤!");

            await Promise.all([
                db.collection("users").doc(id).set({id, pw, nick: id, createdAt: new Date()}),
                rdb.ref(`users/${id}`).set({id, pw})
            ]);
            alert("ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
        } catch(e) { alert("ê°€ì… ì˜¤ë¥˜: " + e.message); }
    };

    // í†µí•© ë¡œê·¸ì¸
    window.handleLogin = async () => {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();

        try {
            const doc = await db.collection("users").doc(id).get();
            if(doc.exists && doc.data().pw === pw) {
                currentUser = doc.data();
                localStorage.setItem('star_user_id', id);
                goMain();
            } else alert("ë¡œê·¸ì¸ ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");
        } catch(e) { alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + e.message); }
    };

    function goMain() {
        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('main-nav').style.display = 'flex';
        loadVideos();
        loadFriends();
    }

    // ë¹„ë””ì˜¤ ë°ì´í„° ë¡œë“œ (Firestore)
    function loadVideos() {
        db.collection("videos").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('video-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const v = doc.data();
                const div = document.createElement('div');
                div.className = 'v-card';
                div.innerHTML = `<video src="${v.url}" controls poster="https://via.placeholder.com/300x170/1a1a2e/ffffff?text=Star+Video"></video>
                                <div style="padding:10px; font-size:12px;"><b>${v.title}</b><br><span style="color:#888;">By ${v.uploader}</span></div>`;
                list.appendChild(div);
            });
        });
    }

    // ë¹„ë””ì˜¤ ì—…ë¡œë“œ (Storage + Firestore)
    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        alert("ì˜ìƒì„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...");
        try {
            const ref = storage.ref('videos/' + Date.now() + "_" + file.name);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            await db.collection("videos").add({
                title: file.name, url, uploader: currentUser.id, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("ì—…ë¡œë“œ ì™„ë£Œ!");
        } catch(e) { alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); }
    };

    // í™”ë©´ ì „í™˜
    window.showSec = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
        document.getElementById('nav-' + id).classList.add('active');
    };

    // ì±„íŒ… - ì¹œêµ¬ ì¶”ê°€ (Realtime DB)
    window.addFriend = () => {
        const fid = prompt("ì¶”ê°€í•  ì¹œêµ¬ì˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(fid && fid !== currentUser.id) rdb.ref(`friends/${currentUser.id}/${fid}`).set(true);
    };

    // ì±„íŒ… - ì¹œêµ¬ ëª©ë¡ ë¡œë“œ
    function loadFriends() {
        rdb.ref(`friends/${currentUser.id}`).on('value', snap => {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            if(snap.exists()) {
                Object.keys(snap.val()).forEach(fid => {
                    const d = document.createElement('div');
                    d.style = "padding:18px; background:var(--card); border-radius:12px; margin-bottom:10px; cursor:pointer; border:1px solid #333; display:flex; justify-content:space-between; align-items:center;";
                    d.innerHTML = `<span>ğŸ‘¤ <b>${fid}</b></span> <span style="font-size:12px; color:var(--main-red);">ëŒ€í™”í•˜ê¸° &rsaquo;</span>`;
                    d.onclick = () => openChat(fid);
                    list.appendChild(d);
                });
            }
        });
    }

    // ì±„íŒ… - ëŒ€í™”ì°½ ì—´ê¸°
    function openChat(fid) {
        activeRid = [currentUser.id, fid].sort().join('_');
        document.getElementById('chat-target').innerText = fid + "ë‹˜ê³¼ì˜ ëŒ€í™”";
        document.getElementById('chat-window').style.display = 'flex';
        rdb.ref(`msgs/${activeRid}`).on('value', snap => {
            const v = document.getElementById('chat-view'); v.innerHTML = '';
            if(snap.exists()) {
                Object.values(snap.val()).forEach(m => {
                    const d = document.createElement('div');
                    d.className = `bubble ${m.s === currentUser.id ? 'me' : ''}`;
                    d.innerText = m.t;
                    v.appendChild(d);
                });
            }
            v.scrollTop = v.scrollHeight;
        });
    }

    // ì±„íŒ… - ë©”ì‹œì§€ ì „ì†¡
    window.sendMsg = () => {
        const i = document.getElementById('msg-input');
        if(!i.value.trim()) return;
        rdb.ref(`msgs/${activeRid}`).push({ s: currentUser.id, t: i.value.trim(), time: Date.now() });
        i.value = '';
    };

    window.closeChat = () => { 
        if(activeRid) rdb.ref(`msgs/${activeRid}`).off();
        document.getElementById('chat-window').style.display = 'none'; 
    };

    window.doLogout = () => { localStorage.clear(); location.reload(); };

    // ìë™ ë¡œê·¸ì¸
    window.onload = async () => {
        const savedId = localStorage.getItem('star_user_id');
        if (savedId) {
            try {
                const doc = await db.collection("users").doc(savedId).get();
                if (doc.exists) { currentUser = doc.data(); goMain(); }
            } catch(e) { localStorage.clear(); }
        }
    };
</script>
</body>
</html>
