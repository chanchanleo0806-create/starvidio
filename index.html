<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>D-Server 대화형 AI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'sans-serif'; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 20px; font-size: 14px; line-height: 1.5; }
        .user { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #input-area { pdding: 20px; background: white; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        button { padding: 10px 20px; background: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="chat-window"></div>
<div id="input-area" style="padding: 15px;">
    <input type="text" id="ai-input" placeholder="메시지를 입력하거나 '사과는 맛있는 과일이야'라고 가르쳐주세요!" onkeypress="if(event.keyCode==13) talk()">
    <button onclick="talk()">전송</button>
</div>

<script>
    // 1. Firebase 설정 (사용자님의 D서버 정보로 자동 연결됨을 가정)
    const firebaseConfig = {
        databaseURL: "https://gun-game-90491-default-rtdb.firebaseio.com/" 
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig, "dServer");
    }
    const dRdb = firebase.app("dServer").database();
    const currentUser = localStorage.getItem('dual_user_id') || "guest_user"; // 테스트용 ID
    let memory = {};

    // 2. D서버에서 기존 지식 불러오기
    dRdb.ref(`collections/${currentUser}/ai_memory`).on('value', (snapshot) => {
        memory = snapshot.val() || {};
        console.log("지식 로드 완료:", Object.keys(memory).length, "개");
    });

    // 3. 말풍선 추가 함수
    function addBubble(text, type) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `bubble ${type}`;
        div.innerText = text;
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    // 4. 핵심 대화 엔진 (통합본)
    function talk() {
        const input = document.getElementById('ai-input');
        const text = input.value.trim();
        if(!text) return;

        addBubble(text, 'user');
        input.value = '';

        // [A] 학습 로직 (~는 ~이야 패턴)
        if (text.includes("는 ") || text.includes("은 ")) {
            let separator = text.includes("는 ") ? "는 " : "은 ";
            let parts = text.split(separator);
            if(parts.length >= 2) {
                let k = parts[0].trim();
                let v = parts[1].replace(/[.!]$/, "").trim(); // 마침표 제거
                
                // D서버 저장
                dRdb.ref(`collections/${currentUser}/ai_memory`).update({ [k]: v });
                addBubble(`${k}에 대해 새로 배웠어! 고마워.`, 'ai');
                return;
            }
        }

        // [B] 대화/검색 로직
        let answer = null;
        for (let key in memory) {
            if (text.includes(key)) {
                answer = memory[key];
                break;
            }
        }

        // [C] 답변 출력
        setTimeout(() => {
            if (answer) {
                const deco = ["음, ", "제 생각에는 ", "알고 계신가요? ", "네! "];
                const finalMsg = deco[Math.floor(Math.random()*deco.length)] + answer;
                addBubble(finalMsg, 'ai');
            } else {
                addBubble(`'${text}'에 대해서는 아직 배운 적이 없어. 'ㅇㅇ은 ㅇㅇ이야'라고 가르쳐줄래?`, 'ai');
            }
        }, 500);
    }

    // 초기 환영 메시지
    window.onload = () => addBubble("안녕! 나는 D서버의 지식을 사용하는 똑똑한 AI야. 무엇이든 물어봐!", "ai");
</script>

</body>
</html>
