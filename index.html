<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STAR TOTAL PLATFORM</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --main-red: #e94560; --bg-dark: #050505; --yellow: #fee500; --card-bg: #16213e; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg-dark); color: white; margin: 0; overflow: hidden; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #1a1a2e; display: flex; justify-content: space-around; align-items: center; border-top: 2px solid var(--main-red); z-index: 1000; }
        nav div { cursor: pointer; font-size: 22px; transition: 0.2s; }
        nav div:hover { transform: scale(1.2); color: var(--main-red); }

        /* ì„¹ì…˜ ê´€ë¦¬ */
        .section { display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 20px; }
        .section.active { display: block; }

        /* ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ */
        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .v-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .v-card video { width: 100%; height: 110px; object-fit: cover; background: #000; }
        .v-info { padding: 10px; font-size: 13px; }

        /* ì±„íŒ… UI */
        #chat-window { position: fixed; inset: 0; background: #abc1d1; display: none; flex-direction: column; z-index: 2000; color: #000; }
        #chat-view { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 8px 12px; border-radius: 12px; font-size: 14px; max-width: 80%; line-height: 1.4; }
        .me { align-self: flex-end; background: var(--yellow); border-top-right-radius: 2px; }
        .you { align-self: flex-start; background: #fff; border-top-left-radius: 2px; }

        /* ì‡¼ì¸  ë ˆì´ì•„ì›ƒ */
        #shorts-container { position: fixed; inset: 0; background: #000; display: none; z-index: 3000; flex-direction: column; overflow-y: scroll; scroll-snap-type: y mandatory; }
        .short-wrapper { width: 100%; height: 100vh; scroll-snap-align: start; display: flex; justify-content: center; align-items: center; position: relative; }
        .short-wrapper video { height: 100%; max-width: 100%; object-fit: cover; }

        /* ë¡œê·¸ì¸ ëª¨ë‹¬ */
        .modal { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .modal-content { background: #1a1a2e; padding: 40px 30px; border-radius: 30px; text-align: center; border: 1px solid var(--main-red); width: 300px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; font-size: 16px; }
    </style>
</head>
<body>

<div id="auth-ui" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--main-red); margin-bottom:20px;">STAR VIDEO & TALK</h2>
        <input type="text" id="log-id" placeholder="ì•„ì´ë””">
        <input type="password" id="log-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="handleLogin()" style="width:100%; padding:15px; background:var(--main-red); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer; margin-top:10px;">ë¡œê·¸ì¸</button>
        <p onclick="handleSignup()" style="font-size:13px; margin-top:20px; cursor:pointer; color:#aaa;">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span style="color:var(--main-red)">íšŒì›ê°€ì…</span></p>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div id="sec-video" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--main-red)">Star Video</h2>
            <button onclick="document.getElementById('file-input').click()" style="background:#4caf50; border:none; color:white; padding:8px 15px; border-radius:8px; font-weight:bold;">ì˜ìƒ ì—…ë¡œë“œ</button>
        </div>
        <div class="v-grid" id="video-list"></div>
    </div>

    <div id="sec-talk" class="section">
        <h2>Messages</h2>
        <div id="friend-list" style="margin-top:20px;"></div>
        <button onclick="addFriend()" style="width:100%; padding:15px; margin-top:15px; border-radius:12px; border:1px dashed #555; background:none; color:#888; cursor:pointer;">+ ì¹œêµ¬ ì¶”ê°€ (ì•„ì´ë”” ì…ë ¥)</button>
    </div>

    <nav>
        <div onclick="showSec('video')">ğŸ </div>
        <div onclick="openShorts()">ğŸ¬</div>
        <div onclick="showSec('talk')">ğŸ’¬</div>
        <div onclick="location.reload()">ğŸšª</div>
    </nav>
</div>

<div id="shorts-container">
    <div onclick="closeShorts()" style="position:fixed; top:20px; right:20px; z-index:3001; font-size:35px; cursor:pointer; color:white;">Ã—</div>
    <div id="shorts-list"></div>
</div>

<div id="chat-window">
    <div style="padding:15px; background:rgba(0,0,0,0.08); display:flex; align-items:center;">
        <button onclick="closeChat()" style="border:none; background:none; font-size:22px; cursor:pointer;">â—€</button>
        <b id="chat-target" style="margin-left:15px; font-size:18px;"></b>
    </div>
    <div id="chat-view"></div>
    <div style="padding:15px; background:#fff; display:flex; gap:10px; align-items:center;">
        <input type="text" id="msg-input" style="flex:1; padding:12px; border-radius:25px; border:1px solid #ddd; outline:none; color:#000;" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMsg()">
        <button onclick="sendMsg()" style="background:var(--yellow); border:none; width:50px; height:40px; border-radius:20px; font-weight:bold; cursor:pointer;">ì „ì†¡</button>
    </div>
</div>

<input type="file" id="file-input" style="display:none" accept="video/*">

<script>
    // --- íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • (Star Video ì •ë³´ ì¶”ì¶œë³¸) ---
    const firebaseConfig = {
        apiKey: "AIzaSyA-Qkz57KR0i55lTbrsu0rZk282-ma_4MA",
        authDomain: "star-vidio.firebaseapp.com",
        projectId: "star-vidio",
        storageBucket: "star-vidio.firebasestorage.app",
        messagingSenderId: "1035567764991",
        appId: "1:1035567764991:web:4fd92a5591da039da503ca",
        databaseURL: "https://star-vidio-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();      // ë¹„ë””ì˜¤/ìœ ì € ë°ì´í„°
    const rdb = firebase.database();    // ì‹¤ì‹œê°„ ì±„íŒ…/ì¹œêµ¬ ë°ì´í„°
    const storage = firebase.storage(); // ë¹„ë””ì˜¤ íŒŒì¼ ì„œë²„

    let currentUser = null;
    let activeRid = null;

    // --- [ID ì—°ë™] í†µí•© íšŒì›ê°€ì… ---
    async function handleSignup() {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();
        if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”!");

        const check = await db.collection("users").doc(id).get();
        if(check.exists) return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");

        // ë‘ DBì— ë™ì‹œì— ì•„ì´ë”” ë“±ë¡
        await Promise.all([
            db.collection("users").doc(id).set({id, pw, nick: id, createdAt: new Date()}),
            rdb.ref(`users/${id}`).set({id, pw})
        ]);
        alert("ğŸ‰ íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.");
    }

    // --- [ID ì—°ë™] í†µí•© ë¡œê·¸ì¸ ---
    async function handleLogin() {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();

        const doc = await db.collection("users").doc(id).get();
        if(doc.exists && doc.data().pw === pw) {
            currentUser = doc.data();
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            loadVideos();
            loadFriends();
        } else alert("ë¡œê·¸ì¸ ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");
    }

    // --- [ë¹„ë””ì˜¤ ê¸°ëŠ¥] ì—…ë¡œë“œ ë° ëª©ë¡ ---
    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        alert("ì˜ìƒì„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");
        
        const fileRef = storage.ref('videos/' + Date.now() + "_" + file.name);
        await fileRef.put(file);
        const url = await fileRef.getDownloadURL();
        
        await db.collection("videos").add({
            title: file.name, url, uploader: currentUser.id, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            likes: 0
        });
        alert("âœ… ì—…ë¡œë“œ ì™„ë£Œ!");
    };

    function loadVideos() {
        db.collection("videos").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('video-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const v = doc.data();
                const div = document.createElement('div');
                div.className = 'v-card';
                div.innerHTML = `<video src="${v.url}" muted></video>
                    <div class="v-info"><b>${v.title}</b><br><small>By ${v.uploader}</small></div>`;
                div.onclick = () => playVideoInShorts(v.url);
                list.appendChild(div);
            });
        });
    }

    // --- [ì‡¼ì¸  ê¸°ëŠ¥] ì „ì²´í™”ë©´ ê°ìƒ ---
    async function openShorts() {
        const container = document.getElementById('shorts-container');
        const list = document.getElementById('shorts-list');
        container.style.display = 'flex';
        list.innerHTML = '';
        const snap = await db.collection("videos").get();
        snap.forEach(doc => {
            const div = document.createElement('div');
            div.className = 'short-wrapper';
            div.innerHTML = `<video src="${doc.data().url}" loop autoplay muted onclick="this.paused?this.play():this.pause()"></video>`;
            list.appendChild(div);
        });
    }
    function playVideoInShorts(url) {
        openShorts().then(() => {
            const list = document.getElementById('shorts-list');
            list.innerHTML = `<div class="short-wrapper"><video src="${url}" loop autoplay controls></video></div>`;
        });
    }
    function closeShorts() { document.getElementById('shorts-container').style.display = 'none'; }

    // --- [ì±„íŒ… ê¸°ëŠ¥] ì‹¤ì‹œê°„ ëŒ€í™” ---
    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
    }

    function addFriend() {
        const fId = prompt("ì¶”ê°€í•  ì¹œêµ¬ì˜ ì•„ì´ë””ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”:");
        if(fId) rdb.ref(`friends/${currentUser.id}/${fId}`).set(true);
    }

    function loadFriends() {
        rdb.ref(`friends/${currentUser.id}`).on('value', snap => {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            if(snap.exists()) {
                Object.keys(snap.val()).forEach(fid => {
                    const d = document.createElement('div');
                    d.style = "padding:20px; background:#16213e; border-radius:15px; margin-bottom:12px; cursor:pointer; display:flex; justify-content:space-between;";
                    d.innerHTML = `<span>ğŸ‘¤ <b>${fid}</b></span> <span style="color:var(--yellow)">ì±„íŒ…í•˜ê¸° â–¶</span>`;
                    d.onclick = () => openChat(fid);
                    list.appendChild(d);
                });
            }
        });
    }

    function openChat(fid) {
        activeRid = [currentUser.id, fid].sort().join('_');
        document.getElementById('chat-target').innerText = fid + "ë‹˜ê³¼ì˜ ëŒ€í™”";
        document.getElementById('chat-window').style.display = 'flex';
        rdb.ref(`msgs/${activeRid}`).on('value', snap => {
            const v = document.getElementById('chat-view'); v.innerHTML = '';
            if(snap.exists()) {
                Object.values(snap.val()).forEach(m => {
                    const d = document.createElement('div');
                    d.className = `bubble ${m.s === currentUser.id ? 'me' : 'you'}`;
                    d.innerText = m.t;
                    v.appendChild(d);
                });
            }
            v.scrollTop = v.scrollHeight;
        });
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value.trim()) return;
        rdb.ref(`msgs/${activeRid}`).push({ s: currentUser.id, t: i.value.trim(), time: Date.now() });
        i.value = '';
    }

    function closeChat() { 
        if(activeRid) rdb.ref(`msgs/${activeRid}`).off();
        document.getElementById('chat-window').style.display = 'none'; 
    }
</script>
</body>
</html>
