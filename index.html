<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dual Server Platform</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --main-red: #ff4757; --bg: #0a0a0c; --card: #1a1a2e; --accent: #6366f1; }
        body { font-family: 'Malgun Gothic', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        header { background: #111; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--main-red); }
        nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #111; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .section { display: none; height: calc(100vh - 125px); overflow-y: auto; padding: 15px; }
        .section.active { display: block; }
        .bubble { padding: 12px; border-radius: 12px; font-size: 14px; margin-bottom: 10px; max-width: 80%; }
        .ai { align-self: flex-start; background: #334155; }
        .user { align-self: flex-end; background: var(--accent); }
        #auth-ui { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--card); padding: 30px; border-radius: 25px; width: 300px; text-align: center; border: 1px solid var(--main-red); }
        input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #050505; color: white; outline: none; }
        .btn { background: var(--main-red); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="auth-ui">
    <div class="auth-box">
        <h2 style="color:var(--main-red); margin:0;">â˜… STAR LOGIN</h2>
        <p style="font-size: 10px; color:#555; margin-bottom:15px;">ID Server: id-d5c4d ì—°ê²°ë¨</p>
        <input type="text" id="log-id" placeholder="ì•„ì´ë””">
        <input type="password" id="log-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
        <p onclick="handleSignup()" style="font-size:12px; margin-top:20px; cursor:pointer; color:#888;">íšŒì›ê°€ì…</p>

        <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #333; text-align: left;">
            <p style="font-size: 10px; color: #444; line-height: 1.5; margin: 0;">
                <b>[ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨]</b><br>
                - ì•„ì´ë”” ì„œë²„: id-d5c4d (ê³„ì • ì •ë³´ ì €ì¥)<br>
                - ìˆ˜ì§‘ê³µê°„(Dì„œë²„): gun-game-90491 (í•™ìŠµ ë° í™œë™ ë°ì´í„° ì €ì¥)
            </p>
        </div>
    </div>
</div>

<header id="main-header" style="display:none;">
    <div style="color:var(--main-red); font-weight:bold;">STAR DUAL-SYSTEM</div>
    <div id="user-display" style="font-size: 12px; color: #888;"></div>
</header>

<div id="main-app" style="display:none;">
    <div id="sec-ai" class="section active">
        <div id="chat-view" style="display:flex; flex-direction:column;"></div>
        <div style="position:fixed; bottom:70px; width:calc(100% - 30px); display:flex; gap:10px;">
            <input type="text" id="ai-input" style="flex:1;" placeholder="AIì—ê²Œ ê°€ë¥´ì¹˜ê¸° (ë‹¨ì–´ëŠ” ëœ»)...">
            <button onclick="talk()" style="background:var(--accent); border:none; padding:10px 15px; border-radius:10px; color:white;">ì „ì†¡</button>
        </div>
    </div>
</div>

<nav id="main-nav" style="display:none;">
    <div onclick="showSec('ai')" id="nav-ai" class="active">ğŸ¤– AI</div>
    <div onclick="doLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
</nav>

<script>
    // 1. ID ì„œë²„ ì„¤ì • (ì•„ì´ë”” ì €ì¥ìš©)
    const idServerConfig = {
        apiKey: "AIzaSyDtvTt2O90SlBgONaIs2ahWJX_3N_-xjso",
        authDomain: "id-d5c4d.firebaseapp.com",
        projectId: "id-d5c4d",
        storageBucket: "id-d5c4d.firebasestorage.app",
        databaseURL: "https://id-d5c4d-default-rtdb.firebaseio.com" // ë§Œì•½ RTDBë„ ì‚¬ìš©í•œë‹¤ë©´
    };

    // 2. Dì„œë²„ ì„¤ì • (ë°ì´í„° ìˆ˜ì§‘ìš© - Gun Game)
    const dServerConfig = {
        apiKey: "AIzaSyD_8QEOfKW32mQ1WBRLmp8zdSTf_e2ZAsI",
        databaseURL: "https://gun-game-90491-default-rtdb.firebaseio.com",
        projectId: "gun-game-90491"
    };

    // ì„œë²„ ì´ˆê¸°í™”
    const idApp = firebase.initializeApp(idServerConfig, "idServer");
    const dApp = firebase.initializeApp(dServerConfig, "dServer");

    const idDb = idApp.firestore(); // IDëŠ” id-d5c4dì˜ Firestoreì— ì €ì¥
    const dRdb = dApp.database();   // ìˆ˜ì§‘ ë°ì´í„°ëŠ” gun-gameì˜ Realtime DBì— ì €ì¥

    let currentUser = null;
    let memory = {};

    // [íšŒì›ê°€ì…] - ID ì„œë²„ì— ì €ì¥
    window.handleSignup = async () => {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();
        if(!id || !pw) return alert("ì…ë ¥ í•„ìˆ˜");
        
        const check = await idDb.collection("users").doc(id).get();
        if(check.exists) return alert("ì¤‘ë³µëœ ì•„ì´ë””");

        await idDb.collection("users").doc(id).set({id, pw, type: "member"});
        alert("IDì„œë²„ì— ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    // [ë¡œê·¸ì¸] - ID ì„œë²„ì—ì„œ í™•ì¸
    window.handleLogin = async () => {
        const id = document.getElementById('log-id').value.trim().toLowerCase();
        const pw = document.getElementById('log-pw').value.trim();
        
        const doc = await idDb.collection("users").doc(id).get();
        if(doc.exists && doc.data().pw === pw) {
            currentUser = id;
            localStorage.setItem('dual_user_id', id);
            goMain();
        } else {
            alert("ë¡œê·¸ì¸ ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");
        }
    };

    function goMain() {
        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('user-display').innerText = `ì ‘ì†ì¤‘: ${currentUser}`;
        syncDServer(); 
    }

    // [ë°ì´í„° ìˆ˜ì§‘] - Dì„œë²„(Gun-Game)ì™€ ì—°ë™
    function syncDServer() {
        dRdb.ref(`collections/${currentUser}/ai_memory`).on('value', snap => {
            if(snap.exists()) memory = snap.val();
        });
    }

    function talk() {
        const input = document.getElementById('ai-input');
        const text = input.value.trim();
        if(!text) return;

        addBubble(text, 'user');
        
        if(text.includes("ëŠ” ")) {
            const [q, a] = text.split("ëŠ” ");
            memory[q.trim()] = a.trim();
            // ìˆ˜ì§‘ ë°ì´í„°ëŠ” Dì„œë²„(gun-game)ë¡œ ì „ì†¡
            dRdb.ref(`collections/${currentUser}/ai_memory`).set(memory);
            addBubble(`'${q}'ì— ëŒ€í•œ ì •ë³´ë¥¼ Dì„œë²„ì— ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.`, 'ai');
        } else {
            const ans = memory[text] || "ê·¸ ì •ë³´ëŠ” ì•„ì§ Dì„œë²„ì— ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
            addBubble(ans, 'ai');
        }
        input.value = '';
    }

    function addBubble(msg, type) {
        const view = document.getElementById('chat-view');
        const div = document.createElement('div');
        div.className = `bubble ${type}`;
        div.innerText = msg;
        view.appendChild(div);
        view.scrollTop = view.scrollHeight;
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
    }

    function doLogout() { localStorage.clear(); location.reload(); }

    window.onload = async () => {
        const savedId = localStorage.getItem('dual_user_id');
        if (savedId) {
            const doc = await idDb.collection("users").doc(savedId).get();
            if (doc.exists) { currentUser = savedId; goMain(); }
        }
    };
</script>
</body>
</html>
